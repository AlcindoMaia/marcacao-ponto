<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Marca√ß√£o de Ponto</title>

<link rel="stylesheet" href="style.css" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script defer src="app.js"></script>

</head>
<body>

<div class="container">

    <h1 class="titulo">Marca√ß√£o de Ponto</h1>
    <p class="subtitulo">Sistema inteligente de presen√ßa</p>

    <div id="info-funcionario" class="card hidden">
        <h3>Ol√°, <span id="nomeFuncionario"></span></h3>
        <p>ID registado no dispositivo</p>
    </div>

    <button id="btnScanner" class="btnPrimary">üì∑ Ler QR da Obra</button>

    <div id="qr-reader" class="qr hidden"></div>

    <h2 class="secTitle">Registos Semanais</h2>
    <div id="historico" class="listaRegistos"></div>

</div>

</body>
</html>
body {
    margin: 0;
    padding: 0;
    font-family: "Inter", Arial, sans-serif;
    background: linear-gradient(135deg, #0048ff, #00c6ff);
    color: #fff;
}

.container {
    width: 90%;
    max-width: 500px;
    margin: auto;
    text-align: center;
    padding-top: 40px;
}

.titulo {
    font-size: 2.2rem;
    font-weight: 700;
}

.subtitulo {
    margin-top: -10px;
    opacity: 0.8;
}

.card {
    background: #ffffff20;
    padding: 15px;
    margin: 20px 0;
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

.hidden {
    display: none;
}

.btnPrimary {
    width: 100%;
    padding: 14px;
    font-size: 18px;
    border: none;
    border-radius: 12px;
    color: white;
    background: #12c2e9;
    cursor: pointer;
    margin-top: 20px;
}

.btnPrimary:hover {
    background: #0fa0c4;
}

.qr {
    margin-top: 20px;
}

.secTitle {
    margin-top: 40px;
    font-size: 1.4rem;
}

.listaRegistos {
    margin-top: 10px;
    text-align: left;
}

.regItem {
    background: #ffffff20;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
}
// CONFIG SUPABASE
const SUPABASE_URL = "https://npyosbigynxmxdakcymg.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_67e1zdXpV7_PXZ-0_ZmmSw__9ddgDKF";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ----------- 1) OBTER deviceId √öNICO -----------
async function getDeviceId() {
    let id = localStorage.getItem("deviceId");

    if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem("deviceId", id);
    }

    return id;
}

// ----------- 2) CARREGAR DADOS DO FUNCION√ÅRIO -----------
async function carregarFuncionario() {
    const deviceId = await getDeviceId();

    const { data, error } = await supabase
        .from("funcionarios")
        .select("*")
        .eq("device_id", deviceId)
        .maybeSingle();

    if (!data) return null;

    document.getElementById("info-funcionario").classList.remove("hidden");
    document.getElementById("nomeFuncionario").textContent = data.nome;

    return data;
}

// ----------- 3) SCANNER QR PARA MARCAR PONTO -----------
document.getElementById("btnScanner").addEventListener("click", () => {
    iniciarScanner();
});

function iniciarScanner() {
    document.getElementById("qr-reader").classList.remove("hidden");

    const qr = new Html5Qrcode("qr-reader");

    qr.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        async qrData => {

            qr.stop();
            document.getElementById("qr-reader").classList.add("hidden");

            const funcionario = await carregarFuncionario();
            if (!funcionario) {
                alert("Dispositivo n√£o registado! Contacte o administrador.");
                return;
            }

            const obra_id = qrData; // QR cont√©m ID da obra

            navigator.geolocation.getCurrentPosition(async pos => {

                const latitude = pos.coords.latitude;
                const longitude = pos.coords.longitude;

                const { error } = await supabase
                    .from("ponto")
                    .insert({
                        funcionario_id: funcionario.id,
                        obra_id,
                        datahora: new Date().toISOString(),
                        latitude,
                        longitude
                    });

                if (!error) alert("Ponto registado com sucesso!");

            });

        }
    );
}

// ----------- 4) CARREGAR HIST√ìRICO SEMANAL -----------
async function carregarHistorico() {
    const func = await carregarFuncionario();
    if (!func) return;

    const inicioSemana = new Date();
    inicioSemana.setDate(inicioSemana.getDate() - inicioSemana.getDay());

    const { data, error } = await supabase
        .from("ponto")
        .select("*, obras(nome)")
        .eq("funcionario_id", func.id)
        .gte("datahora", inicioSemana.toISOString())
        .order("datahora", { ascending: false });

    const div = document.getElementById("historico");
    div.innerHTML = "";

    data.forEach(reg => {
        const box = document.createElement("div");
        box.className = "regItem";
        box.innerHTML = `
            <strong>${new Date(reg.datahora).toLocaleString()}</strong><br>
            Obra: ${reg.obras?.nome || "(sem nome)"}<br>
            GPS: ${reg.latitude}, ${reg.longitude}
        `;
        div.appendChild(box);
    });
}

carregarFuncionario();
carregarHistorico();
