<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marca√ß√£o de Ponto</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <!-- html5-qrcode (vers√£o est√°vel) -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 14px; max-width:720px; margin:auto; }
    h2 { margin-bottom:6px; }
    label { display:block; margin-top:10px; }
    select, button { padding:10px; font-size:16px; width:100%; box-sizing:border-box; }
    #qr-reader { width:100%; margin-top:12px; }
    .log { margin-top:12px; background:#f6f6f6; padding:8px; border-radius:6px; white-space:pre-wrap; font-size:13px; max-height:180px; overflow:auto; }
  </style>
</head>
<body>
  <h2>üìç Marca√ß√£o de Ponto</h2>

  <label>Funcion√°rio:</label>
  <select id="funcionario"></select>

  <button id="btnStart">üì∑ Ler QR Code</button>
  <div id="qr-reader" style="display:none;"></div>

  <div class="log" id="log">Logs:</div>

<script>
/* ============================
   CONFIGURA√á√ÉO - substituir
   ============================ */
const SUPABASE_URL = https://npyosbigynxmxdakcymg.supabase.co;      // ex: https://xyz.supabase.co
const SUPABASE_ANON_KEY = sb_publishable_67e1zdXpV7_PXZ-0_ZmmSw__9ddgDKF;    // anon public key (RLS aplicado)

/* ============================
   Inicializar Supabase
   ============================ */
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ============================
   Utilit√°rios
   ============================ */
const logEl = document.getElementById('log');
function log(msg){
  const ts = new Date().toLocaleTimeString();
  logEl.textContent = ts + " ‚Äî " + msg + "\n" + logEl.textContent;
  console.log(msg);
}

function hojeIsoDate(){ // retorna YYYY-MM-DD
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

/* ============================
   Carregar funcion√°rios
   ============================ */
async function carregarFuncionarios(){
  try {
    const { data, error } = await supabaseClient
      .from('funcionarios')
      .select('id,nome,codigo')
      .eq('ativo', true)
      .order('nome');

    if (error) {
      log("Erro ao carregar funcion√°rios: " + error.message);
      alert("Erro ao carregar funcion√°rios. Ver console.");
      return;
    }

    const sel = document.getElementById('funcionario');
    sel.innerHTML = '';
    if (!data || data.length === 0){
      sel.innerHTML = '<option value="">(nenhum funcion√°rio)</option>';
      return;
    }
    data.forEach(f=>{
      const opt = document.createElement('option');
      opt.value = f.id;
      opt.textContent = f.nome + (f.codigo ? " ("+f.codigo+")" : "");
      sel.appendChild(opt);
    });
    log("Funcion√°rios carregados: " + data.length);
  } catch (err) {
    console.error(err);
    alert("Erro ao carregar funcion√°rios. Ver consola.");
  }
}

/* ============================
   Scanner QR
   ============================ */
let qrScanner = null;
const readerId = "qr-reader";

async function startScanner(){
  // verificar se biblioteca est√° presente
  if (typeof Html5Qrcode === 'undefined') {
    alert("Erro: html5-qrcode n√£o est√° carregado. Verifica o script CDN.");
    log("html5-qrcode indefinido.");
    return;
  }

  const sel = document.getElementById('funcionario');
  if (!sel.value) {
    alert("Por favor selecione um funcion√°rio antes de ler o QR.");
    return;
  }

  document.getElementById('qr-reader').style.display = "block";
  document.getElementById('btnStart').disabled = true;

  qrScanner = new Html5Qrcode(readerId);

  try {
    await qrScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      qrMessage => {
        // Ao detectar QR
        log("QR detectado: " + qrMessage);
        // parar scanner e processar
        qrScanner.stop().then(()=> {
          document.getElementById('qr-reader').style.display = "none";
          document.getElementById('btnStart').disabled = false;
          tratarQr(qrMessage);
        }).catch(errStop=>{
          console.warn("Erro ao parar scanner:", errStop);
          document.getElementById('qr-reader').style.display = "none";
          document.getElementById('btnStart').disabled = false;
          tratarQr(qrMessage);
        });
      },
      errorMessage => {
        // leitura falhou intermitente (ignorar)
        //console.debug("QR leitura intermitente:", errorMessage);
      }
    );
    log("Scanner iniciado.");
  } catch (err) {
    console.error("Erro ao iniciar scanner:", err);
    alert("N√£o foi poss√≠vel iniciar a c√¢mara. Ver console.");
    document.getElementById('qr-reader').style.display = "none";
    document.getElementById('btnStart').disabled = false;
  }
}

document.getElementById('btnStart').addEventListener('click', startScanner);

/* ============================
   Fun√ß√£o principal: tratar QR
   ============================ */
/*
 Espera QR que contenha o identificador da obra, por exemplo:
 OBRA:U003-74076
 ou apenas o c√≥digo/ID (ex: U003-74076)
*/
async function tratarQr(texto){
  // normalizar
  const txt = String(texto).trim();
  // aceitar formatos "OBRA:XYZ" ou s√≥ "XYZ"
  let obraCodigo = txt;
  if (txt.toUpperCase().startsWith("OBRA:")){
    obraCodigo = txt.split(':').slice(1).join(':').trim();
  }

  if (!obraCodigo){
    alert("QR inv√°lido: n√£o foi identificado c√≥digo da obra.");
    return;
  }

  log("Obra detectada: " + obraCodigo);

  // procurar obra na base
  try {
    const { data: obras, error: obraErr } = await supabaseClient
      .from('obras')
      .select('id,codigo,nome')
      .eq('codigo', obraCodigo)
      .limit(1);

    if (obraErr) { log("Erro ao procurar obra: " + obraErr.message); alert("Erro ao procurar obra."); return; }
    if (!obras || obras.length === 0) { alert("Obra n√£o encontrada: " + obraCodigo); return; }

    const obra = obras[0];
    const funcionarioId = document.getElementById('funcionario').value;

    // marcar ponto (l√≥gica: procurar registo do dia para este funcion√°rio+obra)
    await marcarPontoLogica(funcionarioId, obra.id);

  } catch (err) {
    console.error("Erro ao tratar QR:", err);
    alert("Erro interno. Ver console.");
  }
}

/* ============================
   Fun√ß√£o marcarPontoLogica
   - procura registo do dia
   - se n√£o existir cria com 'entrada'
   - se existir sem 'saida' atualiza com 'saida'
   - se existir com 'entrada' e 'saida' cria novo turno (nova linha com entrada)
   ============================ */
async function marcarPontoLogica(funcionarioId, obraId){
  const today = hojeIsoDate();

  try {
    // obter registos do dia (ordenados por created_at desc para pegar √∫ltimo)
    const { data: existentes, error: selErr } = await supabaseClient
      .from('ponto')
      .select('*')
      .eq('funcionario_id', funcionarioId)
      .eq('obra_id', obraId)
      .eq('data', today)
      .order('created_at', { ascending: false });

    if (selErr) { log("Erro ao consultar ponto: " + selErr.message); alert("Erro ao consultar ponto."); return; }

    // fun√ß√£o para obter geolocation (opcional)
    async function obterPosicao(){
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return resolve(null);
        navigator.geolocation.getCurrentPosition(pos => {
          resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude });
        }, err => {
          // N√£o bloquear por falta de GPS
          console.warn("GPS erro:", err);
          resolve(null);
        }, { enableHighAccuracy: true, timeout: 8000 });
      });
    }

    const pos = await obterPosicao();

    if (!existentes || existentes.length === 0){
      // inserir novo registo com 'entrada'
      const payload = {
        funcionario_id: funcionarioId,
        obra_id: obraId,
        data: today,
        entrada: new Date().toISOString()
      };
      if (pos){ payload.latitude = pos.latitude; payload.longitude = pos.longitude; }

      const { data: ins, error: insErr } = await supabaseClient.from('ponto').insert(payload);
      if (insErr){ log("Erro ao inserir entrada: " + insErr.message); alert("Erro ao registar entrada."); return; }
      log("Entrada registada: " + (pos ? `gps(${pos.latitude},${pos.longitude}) ` : "") + new Date().toLocaleString());
      alert("Entrada registada com sucesso!");
      return;
    }

    // j√° existe registo do dia ‚Äî analisar √∫ltimo
    const ultimo = existentes[0];

    if (!ultimo.saida){
      // atualizar com saida
      const payload = { saida: new Date().toISOString() };
      if (pos){ payload.latitude_saida = pos.latitude; payload.longitude_saida = pos.longitude; } // opcional colunas
      const { data: upd, error: updErr } = await supabaseClient.from('ponto').update(payload).eq('id', ultimo.id);
      if (updErr){ log("Erro ao registar sa√≠da: " + updErr.message); alert("Erro ao registar sa√≠da."); return; }
      log("Sa√≠da registada: " + new Date().toLocaleString());
      alert("Sa√≠da registada com sucesso!");
      return;
    } else {
      // j√° tem entrada e sa√≠da: criar novo turno (nova entrada)
      const payload = {
        funcionario_id: funcionarioId,
        obra_id: obraId,
        data: today,
        entrada: new Date().toISOString()
      };
      if (pos){ payload.latitude = pos.latitude; payload.longitude = pos.longitude; }
      const { data: ins2, error: ins2Err } = await supabaseClient.from('ponto').insert(payload);
      if (ins2Err){ log("Erro ao inserir novo turno: " + ins2Err.message); alert("Erro ao registar novo turno."); return; }
      log("Novo turno - entrada registada: " + new Date().toLocaleString());
      alert("Entrada registada (novo turno)!");
      return;
    }

  } catch (err) {
    console.error("Erro marcarPontoLogica:", err);
    alert("Erro interno ao marcar ponto. Ver console.");
  }
}

/* ============================
   Inicializa√ß√£o
   ============================ */
carregarFuncionarios();
</script>
</body>
</html>
